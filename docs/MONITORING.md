# Monitoring et Observabilit√© - SmartPlanning

## Vue d'ensemble

SmartPlanning int√®gre un syst√®me de monitoring complet bas√© sur OpenTelemetry pour fournir une observabilit√© compl√®te de l'application. Le syst√®me collecte les traces, m√©triques et logs pour une surveillance proactive des performances et de la sant√© de l'application.

**Statut d'impl√©mentation** : ‚úÖ **COMPLET** - Version 1.6.0  
**Interface admin** : ‚úÖ Op√©rationnelle √† `/monitoring`  
**M√©triques temps r√©el** : ‚úÖ Auto-refresh 30 secondes  
**Alertes intelligentes** : ‚úÖ Seuils configurables  
**Validation Zod** : ‚úÖ Dashboard int√©gr√© avec m√©triques d'erreurs  
**Assistant IA** : ‚úÖ Monitoring des performances et usage de l'IA

## Architecture du Monitoring

### üèóÔ∏è **Stack Technologique**

- **OpenTelemetry** : Standard ouvert pour l'observabilit√© (simplifi√©)
- **Service de m√©triques** : Collecte en m√©moire pour performances optimales
- **M√©triques temps r√©el** : Calculs instantan√©s avec persistance locale
- **Logs structur√©s** : Console logging avec corr√©lation contextuelle
- **Interface React** : Dashboard moderne avec Framer Motion
- **API s√©curis√©e** : Endpoints administrateurs (`/api/monitoring/*`)
- **Validation Zod** : Monitoring int√©gr√© des erreurs de validation

### üìä **M√©triques Collect√©es**

#### Authentification
- `auth_attempts_total` : Nombre total de tentatives d'authentification
- `auth_success_rate` : Taux de r√©ussite des connexions
- `auth_duration` : Temps de traitement des authentifications

#### üöÄ Intelligence Artificielle (Assistant IA Planning)
- `ai_requests_total` : Nombre de requ√™tes vers OpenRouter (Gemini 2.0 Flash)
- `ai_request_duration_seconds` : Temps de r√©ponse des requ√™tes IA
- `ai_success_rate` : Taux de r√©ussite des requ√™tes IA
- `ai_tokens_used` : Nombre de tokens consomm√©s
- `ai_wizard_sessions_total` : Nombre de sessions Assistant IA d√©marr√©es
- `ai_wizard_completions_total` : Nombre de g√©n√©rations r√©ussies
- `ai_wizard_step_duration` : Temps pass√© par √©tape du wizard
- `ai_wizard_abandonment_rate` : Taux d'abandon par √©tape

#### G√©n√©ration de Plannings
- `planning_generations_total` : Nombre de plannings g√©n√©r√©s
- `planning_generation_duration` : Temps de g√©n√©ration des plannings
- `planning_success_rate` : Taux de r√©ussite des g√©n√©rations

#### Syst√®me
- `active_users` : Nombre d'utilisateurs actifs
- `memory_usage` : Utilisation de la m√©moire
- `cpu_usage` : Utilisation du CPU
- `database_queries` : M√©triques des requ√™tes base de donn√©es

#### Validation des Donn√©es (Version 1.5.0)
- `validation_errors_total` : Nombre total d'erreurs de validation Zod
- `validation_errors_body` : Erreurs dans les donn√©es body
- `validation_errors_params` : Erreurs dans les param√®tres de route
- `validation_errors_query` : Erreurs dans les param√®tres de requ√™te
- `validation_errors_by_route` : Erreurs group√©es par route API

## Dashboard de Monitoring

### üñ•Ô∏è **Interface d'administration**

Le dashboard `/monitoring` propose 5 sections principales :

1. **Vue d'ensemble** : M√©triques cl√©s et indicateurs globaux
2. **M√©triques** : Donn√©es d√©taill√©es par cat√©gorie
3. **Erreurs Zod** : Dashboard de validation avec graphiques et tableaux
4. **Alertes** : Notifications actives et historique
5. **Syst√®me** : Informations techniques et sant√©

### üìä **Section "Erreurs Zod" - Dashboard de Validation**

#### Vue d'ensemble
Cette section fournit une visualisation compl√®te et interactive des m√©triques d'erreurs de validation Zod collect√©es via OpenTelemetry.

#### Fonctionnalit√©s principales

**1. Onglet "Erreurs Zod"**
- Position : Entre "M√©triques" et "Alertes"
- Ic√¥ne : `Shield` (bouclier)
- Badge dynamique : Affiche le nombre total d'erreurs
- Couleur du badge : ‚ö†Ô∏è Warning (< 100 erreurs) / ‚ùå Error (‚â• 100 erreurs)

**2. Vue d'ensemble enrichie**
Trois nouvelles cartes m√©triques dans la vue d'ensemble :
- **Erreurs de validation** : Nombre total avec indicateur de criticit√©
- **Routes affect√©es** : Nombre de routes API avec des erreurs
- **Type principal** : Type d'erreur le plus fr√©quent (Body/Params/Query)

**3. Alerte contextuelle**
- Seuil : > 100 erreurs de validation
- Type : Warning avec ic√¥ne `AlertTriangle`
- Message : "Le nombre d'erreurs de validation a d√©pass√© le seuil de 100. V√©rifiez vos formulaires c√¥t√© client."

#### Visualisations

**1. M√©triques principales (4 cartes)**
```typescript
interface ValidationMetrics {
  total_errors: number;      // Total des erreurs
  body_errors: number;       // Erreurs dans le body
  params_errors: number;     // Erreurs dans les param√®tres
  query_errors: number;      // Erreurs dans les query params
}
```

**2. Graphique √† barres group√©es**
- **Librairie** : Recharts
- **Type** : BarChart avec barres group√©es
- **Donn√©es** : Top 10 des routes avec le plus d'erreurs
- **Axes** :
  - X : Routes API (format raccourci, ex: `auth/register`)
  - Y : Nombre d'erreurs
- **S√©ries** : 3 barres par route
  - üîµ Body (bleu #3B82F6)
  - üü¢ Params (vert #10B981)
  - üü° Query (jaune #F59E0B)

**3. Tableau d√©taill√©**
- **Colonnes** : Route, Total, Body, Params, Query, S√©v√©rit√©
- **Fonctionnalit√©s** :
  - ‚úÖ Tri par colonne (clic sur en-t√™te)
  - üîç Recherche par route
  - üéØ Filtrage par type (All/Body/Params/Query)
  - üìä Badges de s√©v√©rit√© dynamiques

**4. Syst√®me de s√©v√©rit√©**
```typescript
const getSeverityBadge = (total: number) => {
  if (total >= 50) return "Critique" (rouge)
  if (total >= 20) return "√âlev√©" (orange)
  if (total >= 5) return "Mod√©r√©" (jaune)
  return "Faible" (bleu)
}
```

#### Int√©gration technique

**API Backend**
```typescript
// Endpoint : GET /api/monitoring/metrics/realtime
{
  "validation": {
    "total_errors": 132,
    "body_errors": 89,
    "params_errors": 25,
    "query_errors": 18,
    "by_route": {
      "/api/auth/register": {
        "body": 45,
        "params": 0,
        "query": 2,
        "total": 47
      }
    }
  }
}
```

**Composant React**
```typescript
// frontend/src/components/monitoring/ZodValidationDashboard.tsx
const ZodValidationDashboard: React.FC = () => {
  const [metrics, setMetrics] = useState<ValidationMetrics | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedType, setSelectedType] = useState<'all' | 'body' | 'params' | 'query'>('all');
  
  // Actualisation automatique toutes les 30 secondes
  useEffect(() => {
    const interval = setInterval(fetchValidationMetrics, 30000);
    return () => clearInterval(interval);
  }, []);
}
```

## Syst√®me de Validation Zod

### üîß **Architecture de la validation**

#### Composants principaux

```
backend/src/
‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îú‚îÄ‚îÄ validation.middleware.ts     # Middleware principal
‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.middleware.ts   # Gestionnaire d'erreurs
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                     # Exports centralis√©s
‚îÇ   ‚îú‚îÄ‚îÄ auth.schemas.ts              # Sch√©mas d'authentification
‚îÇ   ‚îú‚îÄ‚îÄ company.schemas.ts           # Sch√©mas d'entreprise
‚îÇ   ‚îî‚îÄ‚îÄ employee.schemas.ts          # Sch√©mas d'employ√©
‚îî‚îÄ‚îÄ monitoring/
    ‚îî‚îÄ‚îÄ metrics.ts                   # Collecte des m√©triques
```

#### Middleware de validation

```typescript
import { validateRequest } from '../middlewares/validation.middleware';
import { registerSchema } from '../schemas/auth.schemas';

// Utilisation sur une route
router.post('/register', 
  validateRequest({ 
    body: registerSchema,
    schemaName: 'auth.register' 
  }),
  registerController
);
```

### üìã **Sch√©mas de validation**

#### Sch√©mas d'authentification
```typescript
const registerSchema = z.object({
  firstName: z.string().min(2, "Minimum 2 caract√®res"),
  lastName: z.string().min(2, "Minimum 2 caract√®res"),
  email: createEmailSchema(),
  password: createPasswordSchema(),
  companyName: z.string().min(2, "Minimum 2 caract√®res"),
  companyAddress: z.string().min(5, "Minimum 5 caract√®res"),
  companySize: z.enum(['small', 'medium', 'large']),
  acceptTerms: z.boolean().refine(val => val === true, {
    message: "Vous devez accepter les conditions d'utilisation"
  })
});
```

#### Sch√©mas d'entreprise
```typescript
const createCompanySchema = z.object({
  name: z.string().min(2, "Minimum 2 caract√®res"),
  siret: z.string().regex(/^\d{14}$/, "SIRET invalide (14 chiffres requis)"),
  address: z.string().min(10, "Adresse compl√®te requise"),
  industry: z.enum(['retail', 'services', 'manufacturing', 'technology']),
  size: z.enum(['small', 'medium', 'large']),
  contactEmail: createEmailSchema(),
  contactPhone: createPhoneSchema()
});
```

#### Fonctions utilitaires
```typescript
// Validation ObjectId MongoDB
const createObjectIdSchema = () => 
  z.string().regex(/^[0-9a-fA-F]{24}$/, "ID MongoDB invalide");

// Validation email
const createEmailSchema = () => 
  z.string().email("L'adresse email n'est pas valide");

// Validation mot de passe
const createPasswordSchema = () => 
  z.string()
    .min(8, "Minimum 8 caract√®res requis")
    .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/, 
           "Format invalide");
```

### üåê **Messages d'erreur fran√ßais**

```typescript
const customErrorMessages = {
  required_error: "Ce champ est obligatoire",
  invalid_type_error: "Type de donn√©es invalide",
  too_small: "Valeur trop petite ou trop courte",
  too_big: "Valeur trop grande ou trop longue",
  invalid_string: "Format de cha√Æne invalide",
  invalid_email: "L'adresse email n'est pas valide",
  invalid_url: "L'URL n'est pas valide",
  invalid_date: "Date invalide",
  invalid_enum_value: "Valeur non autoris√©e",
  unrecognized_keys: "Champs non autoris√©s d√©tect√©s",
  custom: "Validation personnalis√©e √©chou√©e"
};
```

## Impl√©mentation Technique

### üéØ **Architecture Simplifi√©e**

L'impl√©mentation utilise une approche simplifi√©e mais efficace pour le monitoring :

#### Service de M√©triques
- **Classe MetricsService singleton** : Collecte et stockage en m√©moire
- **Calculs temps r√©el** : Moyennes et taux calcul√©s √† la vol√©e
- **Performance optimis√©e** : Pas d'impact sur les performances applicatives
- **Persistance l√©g√®re** : Donn√©es conserv√©es pendant l'uptime du serveur

#### Interface Frontend
- **Page MonitoringPage.tsx** : Dashboard complet avec 5 sections
- **Auto-refresh intelligent** : Mise √† jour toutes les 30 secondes
- **Responsive design** : Compatible mobile et desktop
- **Th√®me adaptatif** : Mode clair/sombre automatique

#### API Endpoints
- **Routes s√©curis√©es** : Middleware admin obligatoire
- **R√©ponses optimis√©es** : JSON structur√© pour performance
- **Gestion d'erreurs** : Fallbacks et messages explicites

### üìà **Collecte des m√©triques**

#### Authentification
```typescript
// Enregistrement des tentatives d'authentification
metricsService.recordAuthAttempt(success, method, userId);

// Exemple d'utilisation
try {
  const user = await authenticateUser(email, password);
  metricsService.recordAuthAttempt(true, 'email', user.id);
} catch (error) {
  metricsService.recordAuthAttempt(false, 'email');
}
```

#### Intelligence Artificielle
```typescript
const startTime = Date.now();
try {
  const response = await openai.chat.completions.create(params);
  const duration = Date.now() - startTime;
  
  metricsService.recordAIRequest(duration, true, 'gpt-4', response.usage?.total_tokens);
} catch (error) {
  const duration = Date.now() - startTime;
  metricsService.recordAIRequest(duration, false, 'gpt-4');
}
```

#### Validation des donn√©es
```typescript
// Enregistrement automatique via middleware
import { metricsService } from '../monitoring/metrics';

// Dans validation.middleware.ts
metricsService.incrementValidationError(
  req.originalUrl,           // Route concern√©e
  'body'                     // Type : body, params, query
);

// Exemple d'utilisation
if (error instanceof ZodError) {
  const validationType = config.body ? 'body' : 
                        config.params ? 'params' : 'query';
  
  metricsService.incrementValidationError(req.originalUrl, validationType);
}
```

## Configuration

### Backend (Node.js)

#### Configuration Simplifi√©e
```bash
# Aucune variable sp√©cifique requise
# Le monitoring fonctionne avec la configuration par d√©faut
NODE_ENV=development  # ou production
PORT=5050

# Seuils d'alertes (optionnel)
VALIDATION_ERROR_THRESHOLD=100
VALIDATION_MONITORING_ENABLED=true
```

#### Initialisation Automatique
```typescript
// app.ts - Middleware automatique
import { metricsMiddleware } from './monitoring/metrics';
import { tracingMiddleware } from './monitoring/telemetry';

app.use(metricsMiddleware);     // Collecte automatique HTTP
app.use(tracingMiddleware);     // Traces OpenTelemetry

// Routes monitoring
app.use('/api/monitoring', monitoringRoutes);
```

### Frontend (React)

#### Configuration Dashboard
```typescript
// frontend/src/pages/MonitoringPage.tsx
const MonitoringPage: React.FC = () => {
  const [selectedTab, setSelectedTab] = useState<'overview' | 'metrics' | 'alerts' | 'system' | 'validation'>('overview');
  
  // Auto-refresh toutes les 30 secondes
  useEffect(() => {
    if (autoRefresh) {
      const interval = setInterval(fetchAllData, 30000);
      return () => clearInterval(interval);
    }
  }, [autoRefresh]);
};
```

## Alertes et Notifications

### Seuils Configur√©s

| M√©trique | Seuil Warning | Seuil Critical |
|----------|---------------|----------------|
| Temps r√©ponse IA | >15s | >30s |
| √âchec authentification | >5% | >10% |
| Utilisateurs actifs | >300 | >500 |
| Utilisation m√©moire | >60% | >80% |
| Temps r√©ponse API | >500ms | >1s |
| Erreurs de validation | >50 | >100 |

### Types d'alertes

- **Info** : Informations g√©n√©rales (charge √©lev√©e)
- **Warning** : Attention requise (performance d√©grad√©e)
- **Error** : Action imm√©diate requise (service indisponible)

### Alertes de validation

```typescript
// G√©n√©ration automatique d'alertes
if (metrics.validation.total_errors > VALIDATION_ERROR_THRESHOLD) {
  alerts.push({
    id: 'high_validation_errors',
    severity: 'warning',
    message: 'Nombre √©lev√© d\'erreurs de validation',
    value: metrics.validation.total_errors,
    threshold: VALIDATION_ERROR_THRESHOLD
  });
}
```

## Tests

### Tests Cypress - Dashboard de Validation

```typescript
describe('Dashboard de Validation Zod', () => {
  it('devrait afficher les m√©triques de validation', () => {
    cy.visit('/monitoring');
    cy.contains('Erreurs Zod').click();
    
    // V√©rifier les m√©triques principales
    cy.contains('Total erreurs').should('be.visible');
    cy.contains('132').should('be.visible');
    
    // V√©rifier le graphique
    cy.get('.recharts-wrapper').should('be.visible');
    
    // V√©rifier le tableau
    cy.contains('Erreurs par route').should('be.visible');
  });

  it('devrait permettre de filtrer les erreurs par type', () => {
    cy.visit('/monitoring');
    cy.contains('Erreurs Zod').click();
    
    // Utiliser le filtre par type
    cy.get('select').select('body');
    
    // V√©rifier que seules les routes avec des erreurs body sont affich√©es
    cy.get('table tbody tr').should('have.length.greaterThan', 0);
  });
});
```

### Tests unitaires

```typescript
describe('Validation Middleware', () => {
  it('devrait valider les donn√©es correctes', async () => {
    const validData = {
      firstName: 'John',
      lastName: 'Doe',
      email: 'john@example.com'
    };
    
    const schema = z.object({
      firstName: z.string().min(2),
      lastName: z.string().min(2),
      email: z.string().email()
    });
    
    expect(() => schema.parse(validData)).not.toThrow();
  });
});
```

## Utilisation

### Int√©gration dans les routes

```typescript
import { validateRequest } from '../middlewares/validation.middleware';
import { createCompanySchema } from '../schemas/company.schemas';

// Route avec validation
router.post('/companies', 
  authenticateToken,
  validateRequest({ 
    body: createCompanySchema,
    schemaName: 'company.create' 
  }),
  createCompanyController
);
```

### Gestion des erreurs

```typescript
// R√©ponse d'erreur standardis√©e
{
  "success": false,
  "message": "Donn√©es de requ√™te invalides",
  "errors": [
    {
      "field": "email",
      "message": "L'adresse email n'est pas valide",
      "code": "invalid_string"
    }
  ],
  "timestamp": "2025-07-17T14:00:00.000Z"
}
```

## Bonnes Pratiques

### üéØ **M√©triques**
- Utiliser des noms coh√©rents et descriptifs
- Inclure des labels pertinents
- √âviter les cardinalit√©s trop √©lev√©es
- Mesurer ce qui compte vraiment

### üîç **Validation**
- **R√©utilisabilit√©** : Cr√©er des fonctions utilitaires pour les validations communes
- **Clart√©** : Messages d'erreur explicites et en fran√ßais
- **Performance** : Sch√©mas optimis√©s pour la rapidit√©
- **Maintenance** : Centralisation dans le dossier `schemas/`

### üìù **Logs**
- Utiliser des formats structur√©s
- Inclure la corr√©lation avec les traces
- Respecter les niveaux de logs
- Prot√©ger les donn√©es sensibles

### ‚ö° **Performance**
- √âchantillonner les traces si n√©cessaire
- Optimiser les requ√™tes de m√©triques
- Utiliser des caches appropri√©s
- Monitorer l'impact du monitoring

## Roadmap

### Phase 1 ‚úÖ (Compl√©t√©e - Version 1.4.0)
- ‚úÖ Configuration OpenTelemetry simplifi√©e
- ‚úÖ M√©triques business essentielles (auth, IA, planning, syst√®me)
- ‚úÖ Interface de monitoring compl√®te (4 sections)
- ‚úÖ Alertes intelligentes avec seuils configurables
- ‚úÖ Auto-refresh temps r√©el (30 secondes)
- ‚úÖ API monitoring s√©curis√©e (admin only)
- ‚úÖ Int√©gration seamless dans l'interface admin

### Phase 1.5 ‚úÖ (Compl√©t√©e - Version 1.5.0)
- ‚úÖ Dashboard de validation des donn√©es avec Zod
- ‚úÖ M√©triques d'erreurs de validation par route et type
- ‚úÖ Graphiques interactifs (Top 10 routes avec erreurs)
- ‚úÖ Tableau d√©taill√© avec tri, filtres et recherche
- ‚úÖ Alertes contextuelles pour seuils d'erreurs d√©pass√©s
- ‚úÖ Tests automatis√©s Cypress pour validation du dashboard
- ‚úÖ Documentation compl√®te du syst√®me de validation

### Phase 2 üîÑ (Future)
- Dashboards Grafana (si besoin)
- Historique persistant base de donn√©es
- Int√©gration notifications externes
- M√©triques avanc√©es de business

### Phase 3 üìã (Planifi√©)
- Machine learning pour anomalies
- Pr√©dictions de charge
- Optimisations automatiques
- Rapports d'analyse avanc√©s

## M√©triques de performance

### KPIs suivis

- **Temps de validation** : < 50ms par requ√™te
- **Taux d'erreur** : < 5% des requ√™tes
- **Couverture** : 100% des endpoints publics
- **Disponibilit√©** : 99.9% du dashboard de monitoring

### Optimisations

- **Sch√©mas compil√©s** : Validation rapide avec Zod
- **Cache des sch√©mas** : R√©utilisation des instances
- **Validation lazy** : Chargement √† la demande
- **M√©triques asynchrones** : Pas d'impact sur les performances

## Support

Pour toute question ou probl√®me :
1. Consulter les logs : `backend/logs/`
2. V√©rifier la sant√© : `/api/monitoring/health`
3. Consulter cette documentation
4. Contacter l'√©quipe technique

---

**Note** : Ce syst√®me de monitoring est con√ßu pour √©voluer avec les besoins de SmartPlanning. Les m√©triques et alertes peuvent √™tre ajust√©es selon les retours d'exp√©rience et les exigences business.

**Version** : 1.5.0 - Monitoring complet avec validation Zod int√©gr√©e